name: Connection Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  VIP_A: 10.200.0.10
  VIP_B: 10.200.0.20
  NUCLEUS_PORT: 51820
  CLUSTER_SECRET: ci-test-secret-min16

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    name: Unit Tests
    
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Run unit tests
        run: cargo test -p omni-daemon --verbose

  vpn-integration:
    runs-on: ubuntu-latest
    name: VPN Integration Test
    
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t omni-daemon:test .

      - name: Create Docker network
        run: |
          docker network create --subnet=10.88.0.0/24 omni-test-net

      - name: Start Nucleus container
        run: |
          docker run -d --name nucleus \
            --network omni-test-net \
            --ip 10.88.0.2 \
            omni-daemon:test \
            --mode nucleus --port $NUCLEUS_PORT
          sleep 3
          echo "Nucleus started on 10.88.0.2:$NUCLEUS_PORT"

      - name: Start Edge A container
        run: |
          docker run -d --name edge-a \
            --network omni-test-net \
            --ip 10.88.0.10 \
            --privileged \
            --cap-add=NET_ADMIN \
            --device /dev/net/tun:/dev/net/tun \
            omni-daemon:test \
            --nucleus 10.88.0.2:$NUCLEUS_PORT \
            --cluster ci-test \
            --secret "$CLUSTER_SECRET" \
            --vip $VIP_A \
            --port 51820
          sleep 3
          echo "Edge A started with VIP $VIP_A"

      - name: Start Edge B container
        run: |
          docker run -d --name edge-b \
            --network omni-test-net \
            --ip 10.88.0.20 \
            --privileged \
            --cap-add=NET_ADMIN \
            --device /dev/net/tun:/dev/net/tun \
            omni-daemon:test \
            --nucleus 10.88.0.2:$NUCLEUS_PORT \
            --cluster ci-test \
            --secret "$CLUSTER_SECRET" \
            --vip $VIP_B \
            --port 51821
          sleep 5
          echo "Edge B started with VIP $VIP_B"

      - name: Wait for P2P tunnel
        run: |
          echo "Waiting for tunnel establishment..."
          sleep 10
          
          echo "=== Container Status ==="
          docker ps -a
          echo ""
          
          echo "=== Edge A Logs ==="
          docker logs edge-a --tail 20 || true
          echo ""
          
          echo "=== Edge B Logs ==="
          docker logs edge-b --tail 20 || true
          echo ""
          
          echo "=== Edge A Interfaces ==="
          docker exec edge-a ip addr show || true
          echo ""
          
          echo "=== Edge B Interfaces ==="
          docker exec edge-b ip addr show || true

      - name: Run VPN Tests
        id: tests
        run: |
          PING_RESULT="FAILED"
          PING_LATENCY="N/A"
          TCP_RESULT="SKIPPED"
          TCP_THROUGHPUT="N/A"
          
          echo "============================================"
          echo "ðŸš€ OmniNervous VPN Tunnel Test"
          echo "============================================"
          
          # Test 1: Ping over VPN tunnel (Edge A â†’ Edge B)
          echo ""
          echo "ðŸ“ Ping Test ($VIP_A â†’ $VIP_B):"
          
          PING_OUTPUT=$(docker exec edge-a ping -c 5 -W 3 $VIP_B 2>&1) || true
          echo "$PING_OUTPUT"
          
          if echo "$PING_OUTPUT" | grep -q "bytes from"; then
            RECEIVED=$(echo "$PING_OUTPUT" | grep -c "bytes from" || echo "0")
            PING_LATENCY=$(echo "$PING_OUTPUT" | grep "avg" | awk -F'/' '{print $5}' || echo "N/A")
            echo "âœ… Ping: SUCCESS ($RECEIVED/5 packets, avg ${PING_LATENCY}ms)"
            PING_RESULT="PASSED"
          else
            echo "âŒ Ping: FAILED"
          fi
          
          # Test 2: iperf3 (if ping succeeded)
          if [ "$PING_RESULT" = "PASSED" ]; then
            echo ""
            echo "ðŸ“ˆ iperf3 TCP Test ($VIP_A â†’ $VIP_B):"
            
            # Start iperf3 server on Edge B
            docker exec -d edge-b iperf3 -s -p 5201
            sleep 2
            
            # Run iperf3 client on Edge A
            TCP_OUTPUT=$(docker exec edge-a iperf3 -c $VIP_B -p 5201 -t 5 2>&1) || true
            echo "$TCP_OUTPUT"
            
            if echo "$TCP_OUTPUT" | grep -q "bits/sec"; then
              TCP_THROUGHPUT=$(echo "$TCP_OUTPUT" | grep "sender" | tail -1 | grep -oE "[0-9.]+ [MG]bits/sec" | head -1 || echo "N/A")
              echo "âœ… TCP: $TCP_THROUGHPUT"
              TCP_RESULT="PASSED"
            else
              echo "âŒ TCP: Connection failed"
              TCP_RESULT="FAILED"
            fi
          fi
          
          # Summary
          echo ""
          echo "============================================"
          echo "ðŸ“‹ TEST SUMMARY"
          echo "============================================"
          echo "ðŸ“ VPN Ping:  $PING_RESULT ($PING_LATENCY ms)"
          echo "ðŸ“ˆ VPN TCP:   $TCP_RESULT ($TCP_THROUGHPUT)"
          echo "============================================"
          
          # Set outputs
          echo "PING_RESULT=$PING_RESULT" >> $GITHUB_OUTPUT
          echo "PING_LATENCY=$PING_LATENCY" >> $GITHUB_OUTPUT
          echo "TCP_RESULT=$TCP_RESULT" >> $GITHUB_OUTPUT
          echo "TCP_THROUGHPUT=$TCP_THROUGHPUT" >> $GITHUB_OUTPUT
          
          # Fail if ping failed
          if [ "$PING_RESULT" != "PASSED" ]; then
            echo "::warning::VPN ping test failed - tunnel may not be established"
          fi

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Nucleus Logs ==="
          docker logs nucleus || true
          echo ""
          echo "=== Edge A Logs ==="
          docker logs edge-a || true
          echo ""
          echo "=== Edge B Logs ==="
          docker logs edge-b || true

      - name: Generate Job Summary
        if: always()
        run: |
          echo "## ðŸš€ OmniNervous VPN Integration Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Architecture" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "Nucleus (10.88.0.2) â† signaling" >> $GITHUB_STEP_SUMMARY
          echo "Edge A ($VIP_A) â†â”€â”€P2P Tunnelâ”€â”€â†’ Edge B ($VIP_B)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test | Status | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|:---|:---|:---|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ VPN Ping | ${{ steps.tests.outputs.PING_RESULT || 'N/A' }} | ${{ steps.tests.outputs.PING_LATENCY || 'N/A' }} ms |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ˆ VPN TCP | ${{ steps.tests.outputs.TCP_RESULT || 'N/A' }} | ${{ steps.tests.outputs.TCP_THROUGHPUT || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Security Features" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Noise_IKpsk2 (X25519 + ChaCha20-Poly1305)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Cluster PSK Authentication" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… 64-bit HMAC Session IDs" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup
        if: always()
        run: |
          docker stop nucleus edge-a edge-b 2>/dev/null || true
          docker rm nucleus edge-a edge-b 2>/dev/null || true
          docker network rm omni-test-net 2>/dev/null || true
